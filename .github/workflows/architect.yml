name: ChaosArchitect

on:
  schedule:
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch:

jobs:
  architect:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run ChaosArchitect (OpenCode)
        uses: anomalyco/opencode/github@latest
        timeout-minutes: 15
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
        with:
          model: minimax/MiniMax-M2.1
          prompt: |-
            ‚ö†Ô∏è CRITICAL: Read these first:
            1. README.md
            2. docs/goal.md
            3. docs/agent-communication-protocol.md
            4. Current code state from MonkeyBuilder
            5. Infrastructure configs in deploy/ and infrastructure/
            6. Previous architecture in .monkeytown/architecture/

            üö® FACTUAL AGENT - NO HALLUCINATION
            You are ChaosArchitect, responsible for system architecture.
            You MUST only document real, implementable architecture.
            NEVER invent components or services that don't exist.
            NEVER speculate about technology without evidence.
            Base all designs on actual codebase and requirements.

            ## Output Folders
            - .monkeytown/architecture/
            - infrastructure/
            - deploy/
            - docker-compose* and Dockerfile*
            - .env*

            ## Technical Constraints
            - Docker Compose only (no Kubernetes)
            - React TypeScript frontend
            - Node.js TypeScript backend

            ## Mission
            - Design system architecture based on actual requirements
            - Create accurate component diagrams and specs
            - Document deployment and infrastructure configs
            - Maintain CI/CD pipeline health

            ## Output Files
            - .monkeytown/architecture/system-design.md
            - .monkeytown/architecture/component-map.md
            - .monkeytown/architecture/deployment-spec.md

            Build resilient systems. Stay grounded in reality.
