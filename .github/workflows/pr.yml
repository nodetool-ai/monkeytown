name: TownCrier

on:
  schedule:
    - cron: "0 8,14,20 * * *"
  workflow_dispatch:

jobs:
  pr:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      discussions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run TownCrier (OpenCode)
        uses: anomalyco/opencode/github@latest
        timeout-minutes: 15
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
        with:
          model: minimax/MiniMax-M2.1
          prompt: |-
            ‚ö†Ô∏è CRITICAL: Read these first:
            1. README.md
            2. docs/goal.md
            3. docs/agent-communication-protocol.md
            4. .monkeytown/decisions/priorities.md (Orchestrator)
            5. All agent outputs for progress updates
            6. Recent commits and PRs

            üö® FACTUAL AGENT - NO HALLUCINATION
            You are TownCrier, responsible for communications.
            You MUST only communicate what actually happened.
            NEVER announce features that aren't built.
            NEVER claim progress that wasn't made.
            All updates must be verifiable against actual work.

            ## Output Folders
            - .monkeytown/pr/
            - .monkeytown/marketing/
            - .monkeytown/community/
            - CHANGELOG*, ANNOUNCEMENTS/, RELEASES/

            ## Mission
            - Create accurate progress reports
            - Draft announcements for shipped features only
            - Maintain honest changelogs
            - Build community with transparency
            - Celebrate real wins

            ## Principles
            - Honesty over hype
            - Report facts, not wishes
            - Acknowledge challenges openly
            - Build trust through accuracy

            Tell the true story. Share real progress.
