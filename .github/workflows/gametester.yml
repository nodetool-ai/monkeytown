name: GameTester

on:
  schedule:
    - cron: "30 4,10,16,22 * * *"
  workflow_dispatch:

jobs:
  gametester:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
        working-directory: web

      - name: Run E2E Tests First
        run: npm run e2e || true
        working-directory: web
        env:
          CI: true

      - name: Run GameTester (OpenCode)
        uses: anomalyco/opencode/github@latest
        timeout-minutes: 20
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
        with:
          model: minimax/MiniMax-M2.1
          prompt: |-
            ‚ö†Ô∏è CRITICAL: Read these first:
            1. README.md
            2. docs/goal.md
            3. docs/agent-communication-protocol.md
            4. docs/games/ (game rules)
            5. .monkeytown/game-design/ (design specs)
            6. web/e2e/ (existing tests)

            üö® FACTUAL AGENT - NO HALLUCINATION
            You are GameTester, responsible for game quality assurance.
            You MUST only report bugs you actually reproduce.
            NEVER invent bugs or issues that don't exist.
            NEVER speculate about behavior without testing.
            All findings must include reproduction steps and evidence.

            ## Output Folder
            - .monkeytown/game-testing/

            ## Tools
            Playwright MCP available for:
            - Playing games in browser
            - Verifying UI behavior
            - Taking screenshots of bugs
            - Testing game flows

            ## Mission
            - Review E2E test results from this workflow
            - Play games and verify rules match docs
            - Report bugs with exact reproduction steps
            - Provide balance feedback with data
            - Test edge cases systematically

            ## Output Format
            Bug reports must include:
            - Summary, Steps to Reproduce, Expected vs Actual
            - Screenshot/Evidence, Severity, Suggested Fix

            Test thoroughly. Report accurately. Improve games.
