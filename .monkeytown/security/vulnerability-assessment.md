# Monkeytown Vulnerability Assessment

**Comprehensive security vulnerability analysis**

---

## Vulnerability Inventory

### Critical Severity (CVSS 9.0-10.0)

#### VULN-001: Hardcoded JWT Secret Fallback

**Location:** `server/src/websocket/server.ts:120`

```typescript
const decoded = jwt.default.verify(token, process.env.JWT_SECRET || 'dev-secret') as { playerId: string };
```

**Description:**
The WebSocket authentication uses a fallback JWT secret 'dev-secret' when the environment variable is not set. This secret is predictable and well-known, allowing attackers to forge valid authentication tokens.

**Impact:**
- Complete account takeover
- Ability to join any game session
- Privilege escalation to agent impersonation

**Exploitability:**
- Easy to exploit (known secret)
- No authentication required to attempt exploit
- Works remotely

**CVSS Score:** 9.1 (Critical)

**CVSS Vector:** CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N

**Remediation:**
```typescript
// Require JWT_SECRET in production
const JWT_SECRET = process.env.JWT_SECRET;
if (!JWT_SECRET && process.env.NODE_ENV === 'production') {
  throw new Error('JWT_SECRET environment variable is required');
}
const decoded = jwt.default.verify(token, JWT_SECRET) as { playerId: string };
```

**Status:** Unpatched

---

#### VULN-002: Missing Input Validation on Game Actions

**Location:** `server/src/game/session.ts:53-61`

```typescript
updatePlayer(sessionId: string, playerId: string, updates: Partial<Player>): boolean {
  const session = this.sessions.get(sessionId);
  if (!session) return false;
  
  const player = session.players.find(p => p.id === playerId);
  if (!player) return false;
  
  Object.assign(player, updates);  // No validation on updates
  return true;
}
```

**Description:**
The `updatePlayer` method blindly applies any partial updates to player state without validating the data. This allows clients to modify any player property including position, score, and status.

**Impact:**
- Score manipulation
- Position teleportation (game boundaries bypass)
- Status spoofing
- Game state corruption

**Exploitability:**
- Easy to exploit
- Requires valid session and token
- Simple JSON payload modification

**CVSS Score:** 8.1 (High)

**CVSS Vector:** CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N

**Remediation:**
```typescript
interface PlayerUpdates {
  position?: Vector2D;
  score?: number;
  status?: 'connected' | 'disconnected' | 'playing';
}

updatePlayer(sessionId: string, playerId: string, updates: PlayerUpdates): boolean {
  const session = this.sessions.get(sessionId);
  if (!session) return false;
  
  const player = session.players.find(p => p.id === playerId);
  if (!player) return false;
  
  // Validate position bounds
  if (updates.position) {
    if (!isValidPosition(updates.position, session.config.gameBounds)) {
      return false;
    }
    player.position = updates.position;
  }
  
  // Validate score (non-negative, reasonable max)
  if (typeof updates.score === 'number') {
    if (updates.score < 0 || updates.score > MAX_POSSIBLE_SCORE) {
      return false;
    }
    player.score = updates.score;
  }
  
  // Status changes only via server events
  if (updates.status) {
    return false;  // Client cannot directly set status
  }
  
  return true;
}
```

**Status:** Unpatched

---

#### VULN-003: WebSocket Message Rate Limiting Missing

**Location:** `server/src/websocket/server.ts:73-116`

**Description:**
The EventStream handles incoming WebSocket messages without implementing rate limits per connection. While Redis-based rate limiting exists (`incrementRateLimit`), it is not applied to WebSocket message handlers.

**Impact:**
- Denial of service via message flooding
- CPU exhaustion from processing excessive messages
- Network bandwidth exhaustion

**Exploitability:**
- Easy to exploit
- No authentication required to establish connection
- Simple script to flood messages

**CVSS Score:** 7.5 (High)

**CVSS Vector:** CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H

**Remediation:**
```typescript
// Add rate limiting per socket
const RATE_LIMITS = {
  'game:input': { max: 10, windowMs: 1000 },
  'game:chat': { max: 1, windowMs: 1000 },
  'game:join': { max: 5, windowMs: 60000 },
};

private setupSocketListeners(socket: Socket, playerId: string): void {
  const rateLimiters = new Map<string, { count: number; resetTime: number }>();
  
  const checkRateLimit = (eventType: string): boolean => {
    const limit = RATE_LIMITS[eventType as keyof typeof RATE_LIMITS];
    if (!limit) return true;
    
    const now = Date.now();
    const current = rateLimiters.get(eventType);
    
    if (!current || now > current.resetTime) {
      rateLimiters.set(eventType, { count: 1, resetTime: now + limit.windowMs });
      return true;
    }
    
    if (current.count >= limit.max) {
      return false;
    }
    
    current.count++;
    return true;
  };
  
  socket.on('game:input', async (data) => {
    if (!checkRateLimit('game:input')) {
      socket.emit('error', { code: 'RATE_LIMIT', message: 'Too many input actions' });
      return;
    }
    // ... existing handler
  });
}
```

**Status:** Unpatched

---

### High Severity (CVSS 7.0-8.9)

#### VULN-004: Cross-Site WebSocket Hijacking

**Location:** `server/src/websocket/server.ts:17-25`

```typescript
this.io = new SocketIOServer(httpServer, {
  cors: {
    origin: process.env.CORS_ORIGINS?.split(',') || ['http://localhost:3000'],
    credentials: true,
  },
  // ...
});
```

**Description:**
The CORS configuration allows credentials from any origin when the environment variable is not set. This enables cross-site WebSocket hijacking where a malicious site can make requests to the WebSocket server with the user's credentials.

**Impact:**
- Session hijacking via malicious website
- CSRF-style attacks on WebSocket connections
- Token theft via cross-origin requests

**Exploitability:**
- Moderate to exploit
- Requires user to visit malicious site
- Attacker needs to know or guess game server URL

**CVSS Score:** 7.4 (High)

**CVSS Vector:** CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:N

**Remediation:**
```typescript
const ALLOWED_ORIGINS = process.env.CORS_ORIGINS?.split(',') || [];

this.io = new SocketIOServer(httpServer, {
  cors: {
    origin: (origin, callback) => {
      if (ALLOWED_ORIGINS.length === 0 || ALLOWED_ORIGINS.includes(origin)) {
        callback(null, true);
      } else {
        callback(new Error('Not allowed by CORS'));
      }
    },
    credentials: true,
  },
});
```

**Status:** Unpatched

---

#### VULN-005: Chat Message XSS Injection

**Location:** `server/src/websocket/server.ts:105-111`

```typescript
socket.on('game:chat', (data: { gameId: string; message: string }) => {
  this.io.to(`game:${data.gameId}`).emit('game:chat', {
    playerId,
    message: data.message,  // No sanitization
    timestamp: Date.now(),
  });
});
```

**Description:**
Chat messages are broadcast to all players without HTML escaping or sanitization. Malicious JavaScript can be injected through chat messages and executed in other players' browsers.

**Impact:**
- Session hijacking via XSS
- Credential theft
- Malware distribution
- Defacement of game interface

**Exploitability:**
- Easy to exploit
- Requires valid game session
- Simple message with `<script>` tag

**CVSS Score:** 7.1 (High)

**CVSS Vector:** CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:N

**Remediation:**
```typescript
import DOMPurify from 'isomorphic-dompurify';

socket.on('game:chat', (data: { gameId: string; message: string }) => {
  // Sanitize message
  const sanitized = DOMPurify.sanitize(data.message, {
    ALLOWED_TAGS: ['b', 'i', 'u', 'em', 'strong', 'br'],
    ALLOWED_ATTR: [],
  });
  
  // Length limit
  const truncated = sanitized.slice(0, 500);
  
  this.io.to(`game:${data.gameId}`).emit('game:chat', {
    playerId,
    message: truncated,
    timestamp: Date.now(),
  });
});
```

**Status:** Unpatched

---

#### VULN-006: Insecure WebSocket Transport

**Location:** `server/src/websocket/server.ts:17-25`

```typescript
this.io = new SocketIOServer(httpServer, {
  // ...
  transports: ['websocket', 'polling'],  // Allows non-WS transport
});
```

**Description:**
The server accepts both WebSocket and HTTP long-polling transports. While WebSocket is typically encrypted, HTTP polling runs over plain HTTP if not behind TLS-terminating load balancer. Additionally, the order allows fallback to polling which may not have proper security headers.

**Impact:**
- Man-in-the-middle attacks on polling transport
- Session hijacking via network interception
- Token exposure in transit

**Exploitability:**
- Moderate to exploit
- Requires network access
- Easier on unsecured networks

**CVSS Score:** 7.0 (High)

**CVSS Vector:** CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:L/A:N

**Remediation:**
```typescript
this.io = new SocketIOServer(httpServer, {
  // Only allow WebSocket, disable polling
  transports: ['websocket'],
  // Require all connections to use WebSocket
  allowUpgrades: false,
});
```

**Status:** Unpatched

---

### Medium Severity (CVSS 4.0-6.9)

#### VULN-007: Redis Key Space Exhaustion

**Location:** `server/src/services/redis.ts:35-40`

```typescript
async cacheSession(sessionId: string, session: GameSession): Promise<void> {
  await this.client.setex(
    `session:${sessionId}`,
    3600,  // 1 hour TTL
    JSON.stringify(session)
  );
}
```

**Description:**
Redis caching has fixed 1-hour TTL for all sessions. However, no limit on number of sessions or total cache size. An attacker could create many sessions to exhaust Redis memory.

**Impact:**
- Redis memory exhaustion
- Service degradation
- Potential data loss (eviction)

**Exploitability:**
- Moderate to exploit
- Requires authentication (create session)
- Redis memory limits may provide some protection

**CVSS Score:** 5.8 (Medium)

**CVSS Vector:** CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H

**Remediation:**
```typescript
// Implement session quota per player
private MAX_SESSIONS_PER_PLAYER = 5;

async cacheSession(sessionId: string, session: GameSession): Promise<void> {
  // Check if player has too many sessions
  const playerSessions = await this.client.keys(`session:*`);
  const playerSessionCount = playerSessions.filter(
    key => JSON.parse(await this.client.get(key) || '{}')?.players?.some?.(p => p.id === session.players[0]?.id)
  ).length;
  
  if (playerSessionCount >= this.MAX_SESSIONS_PER_PLAYER) {
    throw new Error('Too many active sessions');
  }
  
  await this.client.setex(`session:${sessionId}`, 3600, JSON.stringify(session));
}
```

**Status:** Unpatched

---

#### VULN-008: Missing Security Headers

**Location:** `web/src/app/layout.tsx` (assumed)

**Description:**
The Next.js application is missing important security headers including:
- Content-Security-Policy
- X-Content-Type-Options
- X-Frame-Options
- Strict-Transport-Security

**Impact:**
- XSS attacks more effective
- Clickjacking attacks possible
- MIME type sniffing attacks
- Protocol downgrade attacks

**Exploitability:**
- N/A (enabling headers reduces attack surface)

**CVSS Score:** 5.3 (Medium)

**CVSS Vector:** CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N

**Remediation:**
Add security headers in `next.config.js`:

```javascript
const nextConfig = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: "default-src 'self'; script-src 'self' 'unsafe-inline'; connect-src wss: https:; img-src data: https:;",
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=31536000; includeSubDomains',
          },
        ],
      },
    ];
  },
};
```

**Status:** Unpatched

---

#### VULN-009: No Session Invalidation on Logout

**Location:** `server/src/websocket/server.ts:62-65`

```typescript
socket.on('disconnect', () => {
  console.log(`[EventStream] Player disconnected: ${playerId}`);
  this.connections.delete(playerId);
});
```

**Description:**
When a player disconnects, their connection is removed but the JWT token remains valid. An attacker with a stolen token can continue to use it until it expires (typically 24 hours).

**Impact:**
- Session hijacking persists after logout
- No way to invalidate compromised tokens
- Extended window for token reuse attacks

**Exploitability:**
- Requires token theft
- Token valid for extended period

**CVSS Score:** 5.5 (Medium)

**CVSS Vector:** CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N

**Remediation:**
```typescript
// Implement token blacklist in Redis
private async invalidateToken(token: string): Promise<void> {
  const decoded = jwt.decode(token) as { exp: number };
  const ttl = decoded.exp - Math.floor(Date.now() / 1000);
  await this.redis.setex(`invalidated:${token}`, ttl, 'true');
}

private async isTokenInvalidated(token: string): Promise<boolean> {
  const result = await this.redis.get(`invalidated:${token}`);
  return result === 'true';
}
```

**Status:** Unpatched

---

### Low Severity (CVSS 0.1-3.9)

#### VULN-010: Verbose Error Messages

**Location:** `server/src/websocket/server.ts:44`

```typescript
} catch (error) {
  next(error as Error);  // Exposes stack trace
}
```

**Description:**
Error messages are passed directly to the client which may expose internal implementation details, stack traces, or sensitive information about the server configuration.

**Impact:**
- Information disclosure
- Aids attacker in understanding system architecture
- May expose sensitive data in error objects

**CVSS Score:** 3.7 (Low)

**CVSS Vector:** CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N

**Remediation:**
```typescript
} catch (error) {
  console.error('[Auth] Token validation failed:', error);
  next(new Error('Authentication failed'));
}
```

**Status:** Unpatched

---

#### VULN-011: Missing Request Size Limits

**Location:** `server/src/index.ts` (assumed)

**Description:**
No explicit limit on WebSocket message sizes or HTTP request body sizes. Very large messages could cause memory issues or be used for DoS attacks.

**Impact:**
- Memory exhaustion
- DoS via large payloads
- Potential injection via oversized messages

**CVSS Score:** 3.5 (Low)

**CVSS Vector:** CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:L

**Remediation:**
```typescript
// In Socket.IO server configuration
this.io = new SocketIOServer(httpServer, {
  maxHttpBufferSize: 1e6,  // 1MB limit
  // ...
});
```

**Status:** Unpatched

---

## Vulnerability Summary

| ID | Vulnerability | Severity | CVSS | Status |
|----|---------------|----------|------|--------|
| VULN-001 | Hardcoded JWT Secret | Critical | 9.1 | Unpatched |
| VULN-002 | Missing Input Validation | Critical | 8.1 | Unpatched |
| VULN-003 | Missing WebSocket Rate Limiting | High | 7.5 | Unpatched |
| VULN-004 | Cross-Site WebSocket Hijacking | High | 7.4 | Unpatched |
| VULN-005 | Chat Message XSS | High | 7.1 | Unpatched |
| VULN-006 | Insecure WebSocket Transport | High | 7.0 | Unpatched |
| VULN-007 | Redis Key Space Exhaustion | Medium | 5.8 | Unpatched |
| VULN-008 | Missing Security Headers | Medium | 5.3 | Unpatched |
| VULN-009 | No Session Invalidation | Medium | 5.5 | Unpatched |
| VULN-010 | Verbose Error Messages | Low | 3.7 | Unpatched |
| VULN-011 | Missing Request Size Limits | Low | 3.5 | Unpatched |

---

## Remediation Priority

| Priority | Vulnerabilities | Target Date |
|----------|-----------------|-------------|
| P1 (Immediate) | VULN-001, VULN-002, VULN-003 | 1 week |
| P2 (Short-term) | VULN-004, VULN-005, VULN-006 | 2 weeks |
| P3 (Standard) | VULN-007, VULN-008, VULN-009 | 1 month |
| P4 (Low) | VULN-010, VULN-011 | Next sprint |

---

## Recommended Security Testing

### Automated Testing

```bash
# Dependency vulnerability scanning
npm audit
snyk test

# Static analysis
npm run lint
npx tsc --noEmit

# Security-focused linting
npm install -D eslint-plugin-security
npx eslint --ext .ts,.tsx --plugin security .
```

### Manual Testing Checklist

- [ ] WebSocket fuzzing for input validation bypass
- [ ] JWT token manipulation and forgery attempts
- [ ] Session hijacking via token theft
- [ ] Rate limiting bypass attempts
- [ ] XSS payload injection via chat
- [ ] CSRF token presence verification
- [ ] Authentication bypass attempts
- [ ] Authorization boundary testing

### Recommended Tools

| Tool | Purpose |
|------|---------|
| OWASP ZAP | Web application scanning |
| Burp Suite | Web security testing |
| Socket.IO Fuzzer | WebSocket fuzzing |
| JWT Toolkit | JWT analysis and manipulation |
| Nmap + NSE | Network security scanning |

---

*Vulnerability Assessment Version: 1.0*
*Last Updated: 2026-01-18*
*JungleSecurity - Finding and fixing weaknesses*
